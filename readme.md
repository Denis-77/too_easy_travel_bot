# Too easy travel bot
Telegram-бот для анализа сайта [Hotels.com](https://www.hotels.com/) и поиска подходящих пользователю отелей

## Взаимодействие с пользователем
Пользователь с помощью специальных команд бота может выполнить следующие
действия (получить следующую информацию):
1. Узнать топ самых дешёвых отелей в городе (команда */lowprice*).
2. Узнать топ самых дорогих отелей в городе (команда */highprice*).
3. Узнать топ отелей, наиболее подходящих по цене и расположению от центра
(самые дешёвые и находятся ближе всего к центру) (команда */bestdeal*).
4. Узнать историю поиска отелей (команда */history*)


### Описание работы команд:

### Команда */lowprice*:
После ввода команды у пользователя запрашивается:
1. Город, где будет проводиться поиск.
2. Осуществляется выбор дат заезда и выезда
3. Количество отелей, которые необходимо вывести в результате (не больше
заранее определённого максимума).
4. Необходимость загрузки и вывода фотографий для каждого отеля (“Да/Нет”)
   * При положительном ответе пользователь также вводит количество
необходимых фотографий (не больше заранее определённого
максимума)


### Команда */highprice:*
После ввода команды у пользователя запрашивается:
1. Город, где будет проводиться поиск.
2. Осуществляется выбор дат заезда и выезда
3. Количество отелей, которые необходимо вывести в результате (не больше
заранее определённого максимума).
4. Необходимость загрузки и вывода фотографий для каждого отеля (“Да/Нет”)
   * При положительном ответе пользователь также вводит количество
необходимых фотографий (не больше заранее определённого
максимума)

### Команда */bestdeal*
После ввода команды у пользователя запрашивается:
1. Город, где будет проводиться поиск.
2. Осуществляется выбор дат заезда и выезда
3. Диапазон цен.
4. Диапазон расстояния, на котором находится отель от центра.
5. Количество отелей, которые необходимо вывести в результате (не больше
заранее определённого максимума).
6. Необходимость загрузки и вывода фотографий для каждого отеля (“Да/Нет”)
   * При положительном ответе пользователь также вводит количество
необходимых фотографий (не больше заранее определённого
максимума)

Для команд *lowprice*, *highprice* и *bestdeal* сообщение с результатом команды
содержит краткую информацию по каждому отелю. В эту информацию
входит:
* название отеля
* рейтинг
* как далеко расположен от центра
* цена
* адрес
* N фотографий отеля (если пользователь счёл необходимым их вывод)
* Кнопка для вывода большего количества фотографий

### Команда */history*
После ввода команды пользователю выводится история поиска отелей. Сама история
содержит:
1. Команду, которую вводил пользователь.
2. Дату и время ввода команды.
3. Отели, которые были найдены (в виде кнопок при нажатии на которые ниже выводится
вся информация о выбранном отеле)
---
## Установка
Проект разработан на языке Python.

Запуск проекта осуществляется путём клонирования
репозитория и установки необходимых библиотек
их перечень в файле requirements.txt.

Для работы проекта используется открытый API Hotels, который расположен на
сайте [rapidapi.com](https://rapidapi.com/hub).

Без запущенного скрипта бот на команды (и на что-либо ещё) не реагирует.

Ключи извлекаются из .env (.env.template - шаблон)

Запуск бота выполняется командой *python main.py* из Терминала, из
папки с проектом.

Имя бота:
*@TooEasy_Travel_Bot*
---
## Структура
<ins>Запуск бота выполняется при запуске *main.py*</ins>
## Файл main.py

### Настройка

```python
MAX_HOTELS: int = 10
MAX_PHOTO: int = 5
QUALITY: str = 's'
BETTER_QUALITY: str = 'b'
TIME_ZONE: float = 3.0
```
MAX_HOTELS - максимально допустимое количество выводимых отелей

MAX_PHOTO - максимально допустимое количество выводимых фотографий отелей

QUALITY - качество фото при массовом выводе(обычное)

BETTER_QUALITY - качество фото при выборе одного отеля(улучшенное)

TIME_ZONE - часовой пояс (в часах)

<ins>Сбор информации об искомых отелях осуществляется при помощи присвоения
пользователю состояния</ins>


### При вводе команд:
'help', 'lowprice', 'highprice', 'bestdeal', 'history', 'start'
создается объект User (если еще не создан)

При вводе команд:
'lowprice', 'highprice', 'bestdeal'

запрашивается город поиска, присваивается состояние(state) 1

### В состоянии 1:

по тексту сообщения устанавливается
локализация пользователя, отправляется сообщение
и локализацию в ф-цию *city_search*, которая возвращает города в виде кнопок
изменяется на состояние 2

### В состоянии 2:

* Идет обработка входящих запросов обратного вызова
от нажатых пользователем кнопок прикрепленных к сообщению в функции callback
* затем осуществляется выбор дат заезда и выезда в функции callback_calendar
при помощи [telegram_bot_calendar](https://github.com/artembakhanov/python-telegram-bot-calendar "telegram_bot_calendar")
* изменяется на состояние 3 (для команды bestdeal) или 5 (для команд lowprice и highprice)

### В состоянии 3 и 4:
(только для команды bestdeal)

Запрашивается диапазон цен и расстояний до центра города

### В состоянии 5:

* Запрашивается надо ли фото в виде кнопок
* затем идет обработка входящих запросов обратного вызова
* Если выбран 'вывод без фото' на этом этапе выводится результат поиска
и изменяет состояние на 0
* В ином случае изменяется на состояние 6

### В состоянии 6:

* Запрашивается количество фото к каждому отелю
и выводит результаты поиска.
* После каждого отеля появляется кнопка "Больше фото".
* Изменяет состояние на 0


### Функция callback
отвечает за обработку входящих запросов обратного вызова
от нажатых пользователем кнопок прикрепленных к сообщению
за исключением работы календаря
* Префикс city - присутствует в кнопках выбора города
* Префикс hotel - присутствует в кнопках выбора отеля
* yes / no - обработка кнопок выбора с фотографиями или без
* Если выбран 'вывод без фото' на этом этапе выводится результат поиска

### Сохранение информации:
Все данные об искомом отеле сохраняются в объекте класса User,
когда посылается запрос они сохраняются в БД

## Файл city_search.py

содержит функцию поиска городов:

city - введенный пользователем запрос

locate - локализация

Создает запрос поиска города,
результат выводит в виде словаря

## Файл cls_user.py

Содержит класс для хранения оперативных данных
пользователя

users(dict) - словарь содержащий все объекты
класса

user_id - id пользователя

name - никнейм

locate - локализация

command - введенная команда

city - выбранный город

price - диапазон цен

distance - расстояние до центра города

hotels - кол-во выводимых отелей

photo - кол-во выводимых фото

## Папка botrequests

## Файл bestdeal.py

Функция find_best_deal

user_id - id пользователя

quality - качество фото

создается запрос с указанными параметрами(кроме дистанции)
если найденных отелей меньше заданного пользователем значения, то
запрос создается снова(в виде рекурсии), но не более 4 раз

После чего если запрос с фото, то вызывается ф-ция поиска фото из photo_search.py

## Файл history.py

Функции

**request_change**(Функция для внесения изменений в БД)

**request_extract**(Функция для извлечения информации из БД)

вспомогательные

---
Функция **create_db_dir** для создания БД

---
Функция **save_request** для сохранения запроса и результата

user_id: id пользователя(для сохранения параметров запроса)

response: список найденных отелей(для сохранения
                 параметров найденных отелей)

---
Функция **history** для получения истории поиска

user_id: id пользователя

возвращает историю поиска в виде списка кортежей

---
Функция **get_save_hotel** для получения информации о найденном отеле
по id отеля и локации

hotel_id: id отеля

locate: переменная локации

возвращает информацию об отеле в виде кортежа внутри списка


## Файл low_high_price.py

Функция делает запрос с указанными параметрами

user_id - id пользователя

quality - качество фото

После чего если запрос с фото, то вызывается ф-ция поиска фото из photo_search.py

## Файл photo_search.py

Создает запрос на получение фото к заданному отелю

hotel - id отеля

num_photo - кол-во фото

quality - кач. фото

Возвращает кортеж URL фотографий


